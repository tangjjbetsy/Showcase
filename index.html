<!DOCTYPE html>
<html lang="en"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midi Synthesis through VALLE Model with Fine-tuned Encodec Model</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Midi Synthesis through VALLE Model with Fine-tuned Encodec Model</h1>
        </div>
        <div class="content">
            <h2>Fine-Tuning the Encodec with the ATEPP audios</h2>
            <div>
                We followed the provided training pipelines in the <a href="https://github.com/facebookresearch/audiocraft">audiocraft</a> 
                library and fine-tuned the compression model MusicGen_Encodec_32khz with the ATEPP dataset. 
                Around 7000 performances (~700hs) were used for training. The model was fine-tuned for 40 epochs, taking around 7 hours using two A100 gpus.
                <br>
                <br>
                More details from the <a href="https://arxiv.org/pdf/2306.05284">paper</a>:
                "We use a non-causal five layers EnCodec model for 32 kHz monophonic audio with a stride of 640, 
                resulting in a frame rate of 50 Hz, and an initial hidden size of 64, doubling
                at each of the model's five layers. The embeddings are quantized with a RVQ with four quantizers,
                each with a codebook size of 2048. We follow DÃ©fossez et al. [2022] to train the model on one-second
                audio segments cropped at random in the audio sequence."
                <br>
                <br>
                We randomly selected five reconstructed samples of 10s from the test set as listening examples.
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Sample A</th>
                        <th>Sample B</th>
                        <th>Sample C</th>
                        <th>Sample D</th>
                        <th>Sample E</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Row 1 -->
                    <tr>
                        <td>Groundtruth</td>
                        <td><audio controls>
                            <source src="./audios/reference/A.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio></td>

                        <td><audio controls>
                            <source src="./audios/reference/B.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio></td>

                        <td><audio controls>
                            <source src="./audios/reference/C.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio></td>

                        <td><audio controls>
                            <source src="./audios/reference/D.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio></td>

                        <td><audio controls>
                            <source src="./audios/reference/E.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio></td>

                    </tr>
                    <!-- Row 2 -->
                    <tr>
                        <td>Encodec (w/o fine-tuning)</td>
                        <td><audio controls>
                            <source src="./audios/encodec/A.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio></td>

                        <td><audio controls>
                            <source src="./audios/encodec/B.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio></td>

                        <td><audio controls>
                            <source src="./audios/encodec/C.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio></td>

                        <td><audio controls>
                            <source src="./audios/encodec/D.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio></td>

                        <td><audio controls>
                            <source src="./audios/encodec/E.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio></td>
                    </tr> 
                    <!-- Row 3 -->
                    <tr>
                        <td>Encodec (fine-tuned)</td>
                        <td><audio controls>
                            <source src="./audios/encodec-ft-full/A.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio></td>

                        <td><audio controls>
                            <source src="./audios/encodec-ft-full/B.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio></td>

                        <td><audio controls>
                            <source src="./audios/encodec-ft-full/C.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio></td>

                        <td><audio controls>
                            <source src="./audios/encodec-ft-full/D.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio></td>

                        <td><audio controls>
                            <source src="./audios/encodec-ft-full/E.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio></td>
                    </tr>                 
                </tbody>
            </table>
            <div>

            <h2>Samples from the Vall-E Model</h2>
            <div>
                We have selected four different segments from various performances and compositions, 
                    organized into three distinct groups of samples. 
                    For each group, five types of audio are presented:
                <ol>
                <li><b>Groundtruth</b>: The original audio segment from the performance.</li>
                <li><b>Encodec-FT</b>: Audio reconstructed by the 32khz Encodec model, which was <b>fine-tuned</b> as previously described.</li>
                <li><b>Vall-E + Encodec-FT</b>: Audio generated by the VALLE model, using the fine-tuned Encodec as audio tokenizer.</li></ol>
                <table>
                    <thead>
                        <tr>
                            <th>Source</th>
                            <th>Seg1: 05869</th>
                            <th>Seg2: 05869</th>
                            <th>Seg3: 05869</th>
                            <th>Seg4: 05869</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Row 1 -->
                        <tr>
                            <td>Groundtruth</td>
                            <td><audio controls>
                                <source src="./audios/05869_1_4.mp3" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio></td>

                            <td><audio controls>
                                <source src="sample2.mp3" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio></td>

                            <td><audio controls>
                                <source src="sample3.mp3" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio></td>

                            <td><audio controls>
                                <source src="sample4.mp3" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio></td>

                        </tr>
                        <!-- Row 2 -->
                        <tr>
                            <td>Encodec-FT</td>
                            <td><audio controls>
                                <source src="./audios/05869_1_4_encodec_ft.mp3" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio></td>

                            <td><audio controls>
                                <source src="sample7.mp3" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio></td>

                            <td><audio controls>
                                <source src="sample8.mp3" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio></td>

                            <td><audio controls>
                                <source src="sample9.mp3" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio></td>

                        </tr>
                        <!-- Row 3 -->
                        <tr>
                            <td>Vall-E + Encodec-FT</td>
                            <td><audio controls>
                                <source src="./audios/05869_1_4_valle_encodec_ft.wav" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio></td>

                            <td><audio controls>
                                <source src="sample12.mp3" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio></td>

                            <td><audio controls>
                                <source src="sample13.mp3" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio></td>

                            <td><audio controls>
                                <source src="sample14.mp3" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio></td>
                        </tr>                  
                    </tbody>
                </table>
                <div>
                <br> 
                <br> 
                When training the Valle model, the MIDI files were first tokenized using a method similar to the one used in the score-to-audio project.

                <br> 
                <br>   
                The unoffical implementation of the Vall-E was trained with prompts from the first N (randemly selected, N < 3) seconds of the current uttrance, which is
                different from the way described in the paper (prompted with segments from other utterace by the same speaker). Considering the recording environments cannot be determined 
                as it may varies even in the same album, we temporarily adopted the unoffical way of implementing the prefixing. With the midi tokenization method, one issue came out as that the 
                ending time of the generation was learned to correlated to the bar value. 
                
                <br> 
                <br> 

                In the inference stage, the input midi tokens were constructed in different structure as the training input, 
                for example, given the 3s-prompts and the target synthesised midi as:
                    
                    <pre><code>
                        # The midi PROMPT corresponding to the 3s audio prompt
                        # (Pitch, Velocity, Duration, IOI, Position, Bar)
                        [[  1,   1,   1,   1,   1,   1],
                         [ 40,  37,  10, 388,   7,   4], # -> first note in the first bar
                         [ 36,  32,  10, 389,   8,   4], # -> second note in the first bar
                         [ 39,  42,  12, 448,  89,   5],  
                         [ 47,  40,  15, 442, 165,   5],
                         [  2,   2,   2,   2,   2,   2]]

                        # The TARGET midi (the input when training)
                        # (Pitch, Velocity, Duration, IOI, Position, Bar)
                        [[  1,   1,   1,   1,   1,   1],
                         [ 59,  40,  11, 388, 165,   4],
                         [ 31,  32,  11, 389, 166,   4],
                         [ 43,  35,  14, 389, 167,   5],
                         [ 60,  49,  12, 410, 189,   5],
                         [ 36,  43,  59, 388, 189,   6],
                         [ 48,  47,  16, 388, 189,   6],
                         [  2,   2,   2,   2,   2,   2]]

                        # The input for inference would be PROMPT + TARGET
                        # (Pitch, Velocity, Duration, IOI, Position, Bar)
                        [[  1,   1,   1,   1,   1,   1],
                         [ 40,  37,  10, 388,   7,   4], # -> first note in the first bar
                         [ 36,  32,  10, 389,   8,   4], # -> second note in the first bar
                         [ 39,  42,  12, 448,  89,   5],  
                         [ 47,  40,  15, 442, 165,   5],
                         ------------------------------  # -> concatenate
                         [ 59,  40,  11, 388, 165,   4],
                         [ 31,  32,  11, 389, 166,   4],
                         [ 43,  35,  14, 389, 167,   5],
                         [ 60,  49,  12, 410, 189,   5],
                         [ 36,  43,  59, 388, 189,   6],
                         [ 48,  47,  16, 388, 189,   6],
                         [  2,   2,   2,   2,   2,   2]]
                    </code></pre>
                    
                This leads to the issues in the inference stage, causing inconvience for prompting with other performances or segments rather than 
                just the beginning of the utterance. Moreover, the ending time was also weird due to the bar value differences, generating long silence generated at the end. 
                
                Therefore, we switch to another MIDI tokenization method called REMI, which gives a one-dimentional token sequence rather than an array. 
                This way makes the input closer to the text tokens, and the timing was tokenised by no absolute timing information, as shown below: <br>
                <!-- Insert your image here -->
                <ul>
                <li>REMI</li>
                <div align=center>
                <img src="imgs/remi.png" alt="The REMI tokenization." width=50%>
                </div>
                <li>OCTUPLE</li>
                <div align=center>
                <img src="imgs/octuple.png" alt="The REMI tokenization." width=50%>
                </div>
                </ul>
                However, the gradients exploded as training and the vocabulary sizes as well as the sequence lengths became much larger. 
                We now back to the original method using only pitch, velocity, duration, and ioi to see.
                </div>
                
            </div>
        </div>
    </div>
    <footer>
        <p>&copy; 2024 Your Name or Institution. All rights reserved.</p>
    </footer>
</body>
</html>
